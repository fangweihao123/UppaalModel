# UPPAAL建模
## 题目以及解析:
军事演习行动中，通信班之间需要相互传递位置信息，以便采取军事行动。一个通信班发送自己的已知的位置信息，另一班接收到后，也将自己知道的位置信息返回给原发送班。假设：
①每次通信只在两个班之间进行(称这两个班为一个临时通信组)，同一时间不允许某一个班和其他两个及两个以上的班进行通信，多个通信组可以同时独立进行通信，；
②每次通信时，信息的通信时间均为1s，忽略其他的延时、接收等时间；发送和返回时间合起来是1s
③假设每次通信都是可靠的；
④同一时间只存在1个加密信道（只有通过加密信道，信息才能安全传递，且加密信道在某个时间只能被一个通信组占用）。

利用工具UPPAAL解决以下问题：
1)如果有5个通信班，则最少需要多少时间，让每个通信班都知道所有的位置信息。

题目有一个很关键的点就是只有一个加密通道，就是我们常说的critical section。当两个班在使用这个加密通道的时候，其它班级是无法使用这个通道通信的。而且一次通信可以让双方把自己知道的所有信息进行交换。再加上班级交流的随机性，就产生了巨大的复杂性。这时候就需要借用UPPAAL这个建模及模型验证工具。建立出的模型如下所示

![](https://github.com/fangweihao123/Photo-Repo/raw/master/uppaal1.png)
### 加密通道的模型
![](https://github.com/fangweihao123/Photo-Repo/raw/master/uppaal3.png)
### 通信班的模型
![](https://github.com/fangweihao123/Photo-Repo/raw/master/uppaal5.png)
### 全局变量的声明
可以看出全局变量里有一个clock x,作为统筹最后最小时间的衡量标准。还有一个matrix，里面的行代表班级，列表示该班级知道的班级位置信息，比如matrix[i][j]==1 说明i班级知道j班级的位置，所以一开始矩阵的斜对角线均为1 因为每一个班级知道自己的位置信息。定义了一个pick的channnel，一个广播channel release。sum2函数计算矩阵的值，如果最后矩阵的值如果到达25，说明所有的班级都知道其它班级的位置了。
![](https://github.com/fangweihao123/Photo-Repo/raw/master/uppaal2.png)
### 通道的局部函数
![](https://github.com/fangweihao123/Photo-Repo/raw/master/uppaal4.png)
### 通信班的局部函数以及局部变量

现在我们来看一下各个部分的局部声明。可以看到，通信班有两个状态，一个是free就是不在交流的状态，另外一个就是正在交流的状态。在状态转移的过程中，可以调用acquire函数来获得全局的信息。加密通道也是有两个状态，一个是无人使用的状态，一个是被占用的状态。我把无人使用的状态设置为commited，就是说在通道空闲之后立刻发出pick[ic]!信号来通知其它班级来使用通道，可以让时间最小化。但是len==2的时候也就是通知了两个班级之后就进入交流的状态，使用communicate()函数来改变全局的matrix变量来是交流的班级分享自己的信息，而且各个班级的局部变量locInfo也发生改变，因为知道的位置信息得到更新。在加密通道的模型中有一个队列的局部变量，这个队列只能存储两个班级的信息，因为一次通信只能由两个班级来进行，如果队列的长度小于2，那么就发出pick[c]!的信号，通信班那边收到队列未满的信号，就进入到队列中，当长度为2的时候，加密通道进入Occ状态。将局部clock y 的值设置为0，在Occ这个状态下，将invariant设置为y>=1,guard设置为y<=1，这样的话，通信会在y=1的时候结束，这时候就用到了broadcast chan release,对所有的release?发出release!的信号，正在通信的通信班结束通信的状态。
![](https://github.com/fangweihao123/Photo-Repo/raw/master/uppaal7.png)
### 模拟器的模拟
![](https://github.com/fangweihao123/Photo-Repo/raw/master/uppaal6.png)
### 验证过程

### 验证过程的解读
首先是A[] not deadlock，验证了整个模型是不会进入死循环的，最后验证结果也是绿色的。其次是E<> Channel.Free and x<=6 and sum2() == 25 其验证结果是绿色，说明存在当加密通道的状态为空闲而且时钟的时间小于6的时候，matrix的值成为25，也就是所有的班级都知道对方的位置信息。但是E<> Channel.Free and x<=5 and sum2() == 25是红色，说明不存在这种情况，在五秒内是不可能知道所有其他班级的信息的，最少需要6s才能知道所有的其它通信班的位置。